<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard | Yieldr</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: #000000;
            color: #FFFFFF;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding-top: 60px;
        }

        .header {
        display: flex;
        align-items: flex-start;  /* Changed from center to flex-start */
        justify-content: space-between;
        margin-bottom: 48px;
        flex-wrap: wrap;
        gap: 20px;
    }

        /* Top Navigation */
.top-nav {
    background: #000000;
    border-bottom: 2px solid #1A1A1A;
    padding: 12px 40px;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(10px);
}

.nav-container {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    font-size: 1.5rem;
    font-weight: 800;
    letter-spacing: 0.15em;
    color: #FFFFFF;
    text-decoration: none;
    transition: all 0.2s;
}

.logo:hover {
    color: #00C805;
}

.nav-links {
    display: flex;
    gap: 32px;
    align-items: center;
}

.nav-link {
    color: #8A8A8A;
    text-decoration: none;
    font-size: 15px;
    font-weight: 500;
    transition: all 0.2s;
    position: relative;
}

.nav-link:hover {
    color: #FFFFFF;
}

.nav-link.active {
    color: #00C805;
}

.nav-link.active::after {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 0;
    right: 0;
    height: 2px;
    background: #00C805;
}

@media (max-width: 768px) {
    .top-nav {
        padding: 12px 20px;
    }
    
    .logo {
        font-size: 24px;
    }
    
    .nav-links {
        gap: 16px;
    }
    
    .nav-link {
        font-size: 14px;
    }
}

    .profile-section {
        display: flex;
        align-items: center;
        gap: 20px;
        flex: 1;              /* ADD THIS LINE */
        min-width: 300px;     /* ADD THIS LINE */
    }

        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #00C805;
        }

        .profile-info h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .profile-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 4px 12px;
            background: rgba(0, 200, 5, 0.1);
            border: 1px solid rgba(0, 200, 5, 0.3);
            border-radius: 6px;
            font-size: 12px;
            color: #00C805;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: #0A0A0A;
            border: 2px solid #1A1A1A;
            border-radius: 16px;
            padding: 24px;
        }

        .metric-label {
            font-size: 13px;
            color: #8A8A8A;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #FFFFFF;
        }

        .metric-value.positive {
            color: #00C805;
        }

        .metric-value.negative {
            color: #FF4444;
        }

        /* Section */
        .section {
            background: #0A0A0A;
            border: 2px solid #1A1A1A;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
        }

        .add-btn {
            padding: 8px 16px;
            background: #00C805;
            color: #000000;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-btn:hover:not(:disabled) {
            background: #00E006;
        }

        .add-btn:disabled {
            background: #1A1A1A;
            color: #666;
            cursor: not-allowed;
        }

        /* Wallets */
        .wallets-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .wallet-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #000000;
            border: 2px solid #1A1A1A;
            border-radius: 12px;
        }

        .wallet-item.primary {
            border-color: #00C805;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .wallet-badge {
            padding: 4px 8px;
            background: #00C805;
            color: #000000;
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
            margin-left: 12px;
        }

        .remove-btn {
            padding: 6px 12px;
            background: transparent;
            color: #FF4444;
            border: 1px solid #FF4444;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
/* Fees & Earnings Section */
.fees-earnings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.fee-card {
    background: #000000;
    padding: 16px;
    border-radius: 12px;
    border: 2px solid #1A1A1A;
}

.fee-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
}

.fee-label {
    font-size: 12px;
    color: #8A8A8A;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.edit-icon {
    width: 16px;
    height: 16px;
    color: #00C805;
    cursor: pointer;
    transition: all 0.2s;
}

.edit-icon:hover {
    color: #00E006;
    transform: scale(1.1);
}

.fee-value {
    font-size: 24px;
    font-weight: 700;
    color: #FFFFFF;
}

.fee-value.earnings {
    color: #00C805;
}


.invest-cta-sticky:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(0, 200, 5, 0.4);
}

.invest-cta-sticky h3 {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
}

.invest-cta-sticky p {
    font-size: 14px;
    opacity: 0.9;
}

/* Invest CTA - Top Right Aligned (ADD THIS - IT'S NEW) */
.invest-cta-compact {
    display: none;
    background: linear-gradient(135deg, #00C805 0%, #00E006 100%);
    color: #000000;
    padding: 16px 24px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(0, 200, 5, 0.3);
    border: none;
    font-size: 15px;
    font-weight: 600;
    white-space: nowrap;
}

.invest-cta-compact:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(0, 200, 5, 0.4);
}


/* Edit Fees Modal */
.modal-input-group {
    margin-bottom: 16px;
    text-align: left;
}

.modal-input-group label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
    color: #FFFFFF;
}

.modal-input-group input {
    width: 100%;
    background: #000000;
    border: 2px solid #1A1A1A;
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 14px;
    color: #FFFFFF;
}

.modal-input-group input:focus {
    outline: none;
    border-color: #00C805;
}

.modal-input-group .helper-text {
    font-size: 11px;
    color: #8A8A8A;
    margin-top: 4px;
}

/* Invest Modal Specific */
.invest-modal-content {
    max-width: 600px;
}

.feature-grid {
    display: grid;
    gap: 16px;
    margin: 24px 0;
    text-align: left;
}

.feature-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: #000000;
    border: 1px solid #1A1A1A;
    border-radius: 12px;
}

.feature-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.feature-text h4 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #FFFFFF;
}

.feature-text p {
    font-size: 13px;
    color: #8A8A8A;
    line-height: 1.5;
}

/* Hide all remove buttons in wallets section */
.wallets-list button,
.wallet-item button,
button.remove-wallet-btn,
.remove-btn {
    display: none !important;
}

.discord-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 14px 28px;
    background: #5865F2;
    color: #FFFFFF;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
}

.discord-btn:hover {
    background: #4752C4;
    transform: translateY(-2px);
}



        /* Positions Table */
        .positions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .positions-table th {
            text-align: left;
            padding: 12px;
            font-size: 12px;
            color: #8A8A8A;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #1A1A1A;
        }

        .positions-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #1A1A1A;
        }

        .platform-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(0, 200, 5, 0.1);
            border: 1px solid rgba(0, 200, 5, 0.2);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .type-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .type-badge.lp {
            background: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
        }

        .type-badge.long {
            background: rgba(0, 200, 5, 0.1);
            color: #00C805;
        }

        .type-badge.short {
            background: rgba(255, 68, 68, 0.1);
            color: #FF4444;
        }

        /* Notes Section */
        .notes-item {
            margin-bottom: 24px;
        }

        .notes-item:last-child {
            margin-bottom: 0;
        }

        .notes-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notes-content {
            padding: 16px;
            background: #000000;
            border: 2px solid #1A1A1A;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
            color: #FFFFFF;
        }

        .notes-content.empty {
            color: #8A8A8A;
            font-style: italic;
        }

        textarea {
            width: 100%;
            background: #000000;
            border: 2px solid #1A1A1A;
            border-radius: 12px;
            padding: 16px;
            font-size: 14px;
            color: #FFFFFF;
            font-family: 'Inter', sans-serif;
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: #00C805;
        }

        .word-count {
            text-align: right;
            font-size: 12px;
            color: #8A8A8A;
            margin-top: 4px;
        }

        .word-count.warning {
            color: #FFA500;
        }

        .word-count.error {
            color: #FF4444;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #0A0A0A;
            border: 2px solid #1A1A1A;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: #8A8A8A;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #FFFFFF;
        }

        input[type="text"] {
            width: 100%;
            background: #000000;
            border: 2px solid #1A1A1A;
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 15px;
            color: #FFFFFF;
            font-family: 'Inter', sans-serif;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #00C805;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .refresh-btn {
        position: relative;
        padding: 8px 16px;
        background: transparent;
        color: #00C805;
        border: 2px solid #00C805;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

        .refresh-btn:hover:not(:disabled) {
            background: rgba(0, 200, 5, 0.1);
        }
        .refresh-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
        }

        .refresh-icon {
            width: 16px;
            height: 16px;
            animation: none;
        }

        .refresh-icon.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        

        .submit-btn {
            width: 100%;
            padding: 14px;
            background: #00C805;
            color: #000000;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-btn:hover:not(:disabled) {
            background: #00E006;
        }

        .submit-btn:disabled {
            background: #1A1A1A;
            color: #666;
            cursor: not-allowed;
        }

        /* Timer */
        .timer-display {
            text-align: center;
            margin: 24px 0;
        }

        .timer-value {
            font-size: 48px;
            font-weight: 700;
            color: #00C805;
        }

        .timer-label {
            font-size: 13px;
            color: #8A8A8A;
            margin-top: 8px;
        }

        .status-message {
            text-align: center;
            font-size: 14px;
            color: #8A8A8A;
            margin-top: 16px;
        }

        @media (max-width: 768px) {
            .positions-table {
                font-size: 12px;
            }

            .positions-table th,
            .positions-table td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <body>
        <!-- Top Navigation Bar -->
        <nav class="top-nav">
            <div class="nav-container">
                <a href="/" class="logo">YIELDR</a>
                <div class="nav-links">
                    <a href="/" class="nav-link">Discover</a>
                    <a href="/manager/dashboard.html" class="nav-link active" id="dashboardLink">Dashboard</a>
                </div>
            </div>
        </nav>
    
        <div class="container">
            
            <!-- Header -->
        <div class="header">
            <div class="profile-section">
                <img id="profilePic" class="profile-pic" src="" alt="Profile">
                <div class="profile-info">
                    <h1 id="username">Loading...</h1>
                    <div class="profile-tags" id="tradingTypes"></div>
                </div>
            </div>
            
            <!-- Compact Invest CTA (only visible to investors) -->
            <button class="invest-cta-compact" id="investCTA" onclick="openInvestModal()">
                üöÄ Invest with @<span id="investManagerName"></span>
            </button>
        </div>

        <!-- Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">30d PnL</div>
                <div class="metric-value" id="pnlMetric">$0.00</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">30d ROI</div>
                <div class="metric-value" id="roiMetric">0%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total AUM</div>
                <div class="metric-value" id="aumMetric">$0.00</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Active Positions</div>
                <div class="metric-value" id="positionsMetric">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Win Rate</div>
                <div class="metric-value" id="winRateMetric">0%</div>
            </div>
        </div>

        
        
       <!-- Fees & Earnings Section -->
<div class="section" id="feesEarningsSection">
    <div class="section-header">
        <h2 class="section-title">Fees & Performance</h2>
    </div>
    
    <div class="fees-earnings-grid">
        <!-- Performance Fee -->
        <div class="fee-card">
            <div class="fee-card-header">
                <span class="fee-label">Performance Fee</span>
                <svg class="edit-icon" id="editPerfFee" onclick="openEditFeesModal()" style="display: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
            </div>
            <div class="fee-value" id="performanceFeeDisplay">20%</div>
        </div>

        <!-- AUM Fee -->
        <div class="fee-card">
            <div class="fee-card-header">
                <span class="fee-label">AUM Fee (Annual)</span>
                <svg class="edit-icon" id="editAumFee" onclick="openEditFeesModal()" style="display: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
            </div>
            <div class="fee-value" id="aumFeeDisplay">2%</div>
        </div>

        <!-- Total Earnings -->
        <div class="fee-card">
            <div class="fee-card-header">
                <span class="fee-label">Total Earnings</span>
            </div>
            <div class="fee-value earnings" id="totalEarningsDisplay">$0.00</div>
        </div>

        <!-- Co-Investors -->
        <div class="fee-card">
            <div class="fee-card-header">
                <span class="fee-label">Co-Investors</span>
            </div>
            <div class="fee-value" id="coInvestorsDisplay">0</div>
        </div>
    </div>
</div>


        <!-- Wallets Management -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Connected Wallets</h2>
                <button class="add-btn" onclick="openAddWalletModal()" id="addWalletBtn">+ Add Wallet</button>
            </div>
            <div class="wallets-list" id="walletsList">
                <p style="color: #8A8A8A;">Loading wallets...</p>
            </div>
        </div>

        <!-- Live Positions -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Live Positions</h2>
                <button class="refresh-btn" onclick="refreshPositions()" id="refreshBtn">
                    <svg class="refresh-icon" id="refreshIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
            <div style="overflow-x: auto;">
                <table class="positions-table">
                    <thead>
                        <tr>
                            <th>Asset</th>
                            <th>Platform</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Entry</th>
                            <th>Current</th>
                            <th>PnL</th>
                            <th>ROI</th>
                        </tr>
                    </thead>
                    <tbody id="positionsTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #8A8A8A;">Loading positions...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Strategy Notes -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Trading Strategy & Insights</h2>
            </div>

            <div class="notes-item">
                <div class="notes-label">
                    <span>Market Outlook</span>
                    <button class="add-btn" onclick="openNotesModal('marketOutlook')">Add Notes</button>
                </div>
                <div class="notes-content empty" id="marketOutlookDisplay">
                    No market outlook added yet
                </div>
            </div>

            <div class="notes-item">
                <div class="notes-label">
                    <span>Investment Thesis</span>
                    <button class="add-btn" onclick="openNotesModal('investmentThesis')">Add Notes</button>
                </div>
                <div class="notes-content empty" id="investmentThesisDisplay">
                    No investment thesis added yet
                </div>
            </div>

            <div class="notes-item">
                <div class="notes-label">
                    <span>Position Strategy</span>
                    <button class="add-btn" onclick="openNotesModal('positionStrategy')">Add Notes</button>
                </div>
                <div class="notes-content empty" id="positionStrategyDisplay">
                    No position strategy added yet
                </div>
            </div>
        </div>

        <!-- Live Trading Sessions -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Live Trading Sessions</h2>
                <button class="add-btn" disabled style="opacity: 0.5;">Live Trading (Coming Soon)</button>
            </div>
            <p style="color: #8A8A8A;">No upcoming live trading sessions scheduled</p>
        </div>
    </div>

    <!-- Add Wallet Modal -->
    <div class="modal" id="addWalletModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add & Verify Wallet</h3>
                <button class="close-btn" onclick="closeAddWalletModal()">√ó</button>
            </div>
            <div id="addWalletForm">
                <div class="form-group">
                    <label>Wallet Address</label>
                    <input type="text" id="newWalletAddress" placeholder="0x..." />
                </div>
                <button class="submit-btn" onclick="addAndVerifyWallet()">Add & Verify Wallet</button>
            </div>
            <div id="verifyingState" style="display: none;">
                <div class="timer-display">
                    <div class="timer-value" id="verifyTimer">30</div>
                    <div class="timer-label">seconds remaining</div>
                </div>
                <div class="status-message" id="verifyStatus">Scanning wallet for positions...</div>
            </div>
        </div>
    </div>

    <!-- Add Notes Modal -->
    <div class="modal" id="addNotesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="notesModalTitle">Add Notes</h3>
                <button class="close-btn" onclick="closeNotesModal()">√ó</button>
            </div>
            <div class="form-group">
                <textarea id="notesTextarea" placeholder="Write your notes here..." maxlength="700"></textarea>
                <div class="word-count" id="notesWordCount">0 / 100 words</div>
            </div>
            <button class="submit-btn" onclick="saveNotes()">Save Notes</button>
        </div>
    </div>

    <script>
        let managerData = null;
        let positions = [];
        let currentNotesField = null;
        let walletCount = 0;

        // Load dashboard data
async function loadDashboard() {
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('username') || localStorage.getItem('managerUsername');

    if (!username) {
        alert('No username provided');
        window.location.href = '/onboarding/connect';
        return;
    }

    try {
        console.log('Fetching manager profile for:', username);
        
        // Fetch manager profile
        const response = await fetch(`/api/managers/profile?username=${username}`);
        const data = await response.json();

        console.log('API response:', data);

        if (!data.success || !data.data) {
            console.error('Manager profile not found:', data);
            alert('Manager profile not found. Please complete onboarding.');
            window.location.href = '/onboarding/connect';
            return;
        }

        managerData = data.data;
        console.log('Manager data loaded:', managerData);

        // Display everything in order
        displayManagerInfo();
        displayFeesAndEarnings();      // NEW
        await detectUserType();         // NEW
        await loadWallets();
        await loadPositions();
        loadNotes();

    } catch (error) {
        console.error('Error loading dashboard:', error);
        alert('Failed to load dashboard: ' + error.message);
    }
}

// Load dashboard on page load
loadDashboard();

        function displayManagerInfo() {
            document.getElementById('username').textContent = '@' + managerData.username;
            document.getElementById('profilePic').src = managerData.profilePicture;

            // Trading types tags
            const tagsContainer = document.getElementById('tradingTypes');
            tagsContainer.innerHTML = (managerData.tradingTypes || []).map(type => 
                `<span class="tag">${type.replace('-', ' ')}</span>`
            ).join('');
        }

        async function loadWallets() {
            const wallets = managerData.wallets || [managerData.walletAddress];
            walletCount = wallets.length;

            const walletsList = document.getElementById('walletsList');
            walletsList.innerHTML = wallets.map((wallet, index) => `
                <div class="wallet-item ${index === 0 ? 'primary' : ''}">
                    <div>
                        <span class="wallet-address">${wallet.slice(0, 6)}...${wallet.slice(-4)}</span>
                        ${index === 0 ? '<span class="wallet-badge">Primary</span>' : ''}
                    </div>
                    ${index > 0 ? `<button class="remove-btn" onclick="removeWallet('${wallet}')">Remove</button>` : ''}
                </div>
            `).join('');

            // Update add button
            const addBtn = document.getElementById('addWalletBtn');
            addBtn.disabled = walletCount >= 5;
            if (walletCount >= 5) {
                addBtn.textContent = 'Max 5 Wallets';
            }
        }

        async function loadPositions() {
            try {
                const allWallets = managerData.wallets || [managerData.walletAddress];
                let allPositions = [];

                // Fetch positions for each wallet
                for (const wallet of allWallets) {
                    const response = await fetch(`/api/positions?address=${wallet}`);
                    const data = await response.json();

                    if (data.success && data.data) {
                        allPositions.push(...data.data.lpPositions, ...data.data.perpPositions);
                    }
                }

                positions = allPositions;
                displayPositions();
                updateAggregateMetrics();

            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }

        async function refreshPositions() {
    const refreshBtn = document.getElementById('refreshBtn');
    const refreshIcon = document.getElementById('refreshIcon');
    
    refreshBtn.disabled = true;
    refreshIcon.classList.add('spinning');
    refreshBtn.innerHTML = `
        <svg class="refresh-icon spinning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Refreshing...
    `;

    try {
        const allWallets = managerData.wallets || [managerData.walletAddress];
        let totalPnL = 0;
        let totalAUM = 0;
        let refreshedCount = 0;

        // Fetch fresh data for each wallet
        for (const wallet of allWallets) {
            console.log('Refreshing wallet:', wallet);

            // Fetch LP positions DIRECTLY from Krystal API
            const normalizedWallet = wallet.toLowerCase();
            const krystalUrl = `https://api.krystal.app/all/v1/lp/userPositions?addresses=${normalizedWallet}&chainIds=8453`;
            const lpResponse = await fetch(krystalUrl, { method: 'GET', headers: { 'Accept': 'application/json' } });
            
            let lpData = { success: false, data: { positions: [], summary: { totalPnL: 0, totalLiquidity: 0 } } };
            if (lpResponse.ok) {
                const krystalData = await lpResponse.json();
                const krystalPositions = (krystalData.positions || []).map(pos => ({
                    platform: pos.pool?.project || 'Unknown',
                    pair: `${pos.currentAmounts?.[0]?.token?.symbol}/${pos.currentAmounts?.[1]?.token?.symbol}`,
                    liquidity: pos.currentPositionValue || 0,
                    pnl: pos.pnl || 0,
                    roi: pos.returnOnInvestment || 0
                }));
                lpData = {
                    success: true,
                    data: {
                        positions: krystalPositions,
                        summary: {
                            totalPnL: krystalData.statsByChain?.['8453']?.pnl || 0,
                            totalLiquidity: krystalData.statsByChain?.['8453']?.currentPositionValue || 0
                        }
                    }
                };
            }

            // Fetch Avantis positions from API
            const avantisResponse = await fetch(`/api/avantis-positions?address=${wallet}`);
            const avantisData = await avantisResponse.json();

            // FIXED: Access data correctly
            const lpPositions = lpData.data?.positions || [];
            const avantisPositions = avantisData.data?.positions || [];
            
            console.log(`Wallet ${wallet}: ${lpPositions.length} LP + ${avantisPositions.length} perp positions`);

            // Calculate metrics for this wallet
            const walletPnL = (lpData.data?.summary?.totalPnL || 0) + (avantisData.data?.summary?.totalPnL || 0);
            const walletAUM = (lpData.data?.summary?.totalLiquidity || 0) + (avantisData.data?.summary?.totalMargin || 0);
            
            totalPnL += walletPnL;
            totalAUM += walletAUM;

            // Save fresh positions to MongoDB (this will replace old positions for this wallet)
            await fetch('/api/positions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    walletAddress: wallet,
                    lpPositions: lpPositions,
                    avantisPositions: avantisPositions,
                    metrics: {
                        totalPnL: walletPnL,
                        totalAUM: walletAUM,
                        totalROI: walletAUM > 0 ? (walletPnL / walletAUM * 100) : 0
                    }
                })
            });

            refreshedCount += lpPositions.length + avantisPositions.length;
        }

        // Update manager metrics
        await fetch('/api/managers/profile', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: managerData.username,
                metrics: {
                    totalPnL30d: totalPnL,
                    totalAUM: totalAUM,
                    roi30d: totalAUM > 0 ? (totalPnL / totalAUM * 100) : 0,
                    totalTrades: refreshedCount,
                    lastUpdated: new Date()
                }
            })
        });

        console.log('Refresh complete. Reloading positions...');

        // Reload positions from MongoDB
        await loadPositions();

        // Show success message
        refreshBtn.innerHTML = `
            <svg class="refresh-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Updated!
        `;
        
        setTimeout(() => {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = `
                <svg class="refresh-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Refresh
            `;
        }, 2000);

    } catch (error) {
        console.error('Error refreshing positions:', error);
        alert('Failed to refresh positions: ' + error.message);
        
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = `
            <svg class="refresh-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Refresh
        `;
    }
}

function displayPositions() {
    const tbody = document.getElementById('positionsTableBody');

    if (positions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #8A8A8A;">No positions found</td></tr>';
        return;
    }

    tbody.innerHTML = positions.map(pos => {
        const isLP = pos.type === 'LP';
        
        // Fix: Build asset name from token symbols (works even when pair/pool is null)
        let asset;
        if (isLP) {
            // For LP positions, prefer token symbols from saved data
            if (pos.token0?.symbol && pos.token1?.symbol) {
                asset = `${pos.token0.symbol}/${pos.token1.symbol}`;
            } else {
                // Fallback to pair or pool fields
                asset = pos.pair || pos.pool || 'Unknown LP';
            }
        } else {
            // For perpetual positions, use pair field
            asset = pos.pair || 'Unknown';
        }
        
        const platform = pos.platform || (isLP ? 'Uniswap V3' : 'Avantis');
        const type = isLP ? 'LP' : pos.direction;
        const size = isLP ? pos.liquidity : pos.positionSize;
        const entry = isLP ? 'N/A' : formatPrice(pos.entryPrice);
        const current = isLP ? 'N/A' : formatPrice(pos.currentPrice || pos.entryPrice);

        return `
            <tr>
                <td><strong>${asset}</strong></td>
                <td><span class="platform-badge">${platform}</span></td>
                <td><span class="type-badge ${isLP ? 'lp' : type.toLowerCase()}">${type}</span></td>
                <td>${formatCurrency(size)}</td>
                <td>${entry}</td>
                <td>${current}</td>
                <td style="color: ${pos.pnl >= 0 ? '#00C805' : '#FF4444'}">${formatCurrency(pos.pnl)}</td>
                <td style="color: ${pos.roi >= 0 ? '#00C805' : '#FF4444'}">${formatPercent(pos.roi)}</td>
            </tr>
        `;
    }).join('');
}

        function updateAggregateMetrics() {
            // Calculate total metrics across all wallets
            const totalPnL = positions.reduce((sum, pos) => sum + (pos.pnl || 0), 0);
            const totalAUM = positions.reduce((sum, pos) => {
                return sum + (pos.liquidity || pos.margin || 0);
            }, 0);
            const totalROI = totalAUM > 0 ? (totalPnL / totalAUM * 100) : 0;

            // Calculate win rate (only for perp positions)
            const perpPositions = positions.filter(p => p.type === 'PERP');
            const winningPositions = perpPositions.filter(p => p.pnl > 0).length;
            const winRate = perpPositions.length > 0 ? (winningPositions / perpPositions.length * 100) : 0;

            document.getElementById('pnlMetric').textContent = formatCurrency(totalPnL);
            document.getElementById('pnlMetric').className = 'metric-value ' + (totalPnL >= 0 ? 'positive' : 'negative');
            
            document.getElementById('aumMetric').textContent = formatCurrency(totalAUM);
            
            document.getElementById('roiMetric').textContent = formatPercent(totalROI);
            document.getElementById('roiMetric').className = 'metric-value ' + (totalROI >= 0 ? 'positive' : 'negative');
            
            document.getElementById('positionsMetric').textContent = positions.length;
            document.getElementById('winRateMetric').textContent = winRate.toFixed(1) + '%';
        }

        function loadNotes() {
        const fields = ['marketOutlook', 'investmentThesis', 'positionStrategy'];
        fields.forEach(field => {
            const content = managerData[field];
            const display = document.getElementById(field + 'Display');
            if (content && content.trim()) {
                display.textContent = content;
                display.classList.remove('empty');
            } else {
                display.textContent = 'No notes added yet';
                display.classList.add('empty');
            }
        });
    }

        // Add Wallet Modal
        function openAddWalletModal() {
            if (walletCount >= 5) {
                alert('Maximum 5 wallets allowed');
                return;
            }
            document.getElementById('addWalletModal').classList.add('show');
        }

        function closeAddWalletModal() {
            document.getElementById('addWalletModal').classList.remove('show');
            document.getElementById('addWalletForm').style.display = 'block';
            document.getElementById('verifyingState').style.display = 'none';
            document.getElementById('newWalletAddress').value = '';
        }

        async function addAndVerifyWallet() {
    const walletAddress = document.getElementById('newWalletAddress').value.trim();

    if (!walletAddress || !walletAddress.startsWith('0x')) {
        alert('Please enter a valid wallet address');
        return;
    }

    // Validate format
    if (!walletAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
        alert('Invalid wallet address format. Must be 42 characters.');
        return;
    }

    // Check if wallet already added to this account
    const existingWallets = managerData.wallets || [managerData.walletAddress];
    if (existingWallets.includes(walletAddress.toLowerCase())) {
        alert('This wallet is already connected to your account');
        return;
    }

    // Show verifying state
    document.getElementById('addWalletForm').style.display = 'none';
    document.getElementById('verifyingState').style.display = 'block';

    try {
        // Step 0: Check if wallet is used by another user
        document.getElementById('verifyStatus').textContent = 'Checking wallet availability...';
        
        const walletCheckResponse = await fetch('/api/wallets/check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ walletAddress })
        });

        const walletCheckData = await walletCheckResponse.json();

        if (walletCheckData.inUse) {
            alert(`‚ùå This wallet is already connected to @${walletCheckData.owner.username}'s account. Each wallet can only belong to one user.`);
            closeAddWalletModal();
            return;
        }

        // Start timer for position scanning
        let timeLeft = 30;
        const timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('verifyTimer').textContent = timeLeft;
            if (timeLeft <= 0) clearInterval(timerInterval);
        }, 1000);

        // Step 1: Fetch LP positions DIRECTLY from Krystal API
        document.getElementById('verifyStatus').textContent = 'Scanning wallet for LP positions...';
        
        const normalizedAddress = walletAddress.toLowerCase();
        const krystalUrl = `https://api.krystal.app/all/v1/lp/userPositions?addresses=${normalizedAddress}&chainIds=8453`;
        
        console.log('Fetching LP positions from Krystal:', krystalUrl);
        
        const lpResponse = await fetch(krystalUrl, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });

        // Parse LP data
        let lpData = { 
            success: false, 
            data: { 
                positions: [], 
                summary: { totalPnL: 0, totalLiquidity: 0, totalROI: 0 } 
            } 
        };

        if (lpResponse.ok) {
            const krystalData = await lpResponse.json();
            console.log('Krystal API response:', krystalData);

            const positions = krystalData.positions || [];
            const baseStats = krystalData.statsByChain?.['8453'] || krystalData.statsByChain?.all || {};

            // Format positions to match expected structure
            const formattedPositions = positions.map(pos => {
                const token0 = pos.currentAmounts?.[0]?.token;
                const token1 = pos.currentAmounts?.[1]?.token;
                
                return {
                    platform: pos.pool?.project || 'Unknown',
                    pair: `${token0?.symbol || '?'}/${token1?.symbol || '?'}`,
                    token0: {
                        symbol: token0?.symbol || '',
                        amount: pos.currentAmounts?.[0]?.balance || '0',
                        value: pos.currentAmounts?.[0]?.quotes?.usd?.value || 0
                    },
                    token1: {
                        symbol: token1?.symbol || '',
                        amount: pos.currentAmounts?.[1]?.balance || '0',
                        value: pos.currentAmounts?.[1]?.quotes?.usd?.value || 0
                    },
                    liquidity: pos.currentPositionValue || 0,
                    pnl: pos.pnl || 0,
                    roi: pos.returnOnInvestment || 0,
                    apr: pos.apr || 0,
                    status: pos.status || 'UNKNOWN',
                    unclaimedFees: (pos.feePending || []).reduce((sum, fee) => 
                        sum + (fee.quotes?.usd?.value || 0), 0),
                    positionId: pos.id
                };
            });

            lpData = {
                success: true,
                data: {
                    positions: formattedPositions,
                    summary: {
                        totalPnL: baseStats.pnl || 0,
                        totalLiquidity: baseStats.currentPositionValue || 0,
                        totalROI: baseStats.returnOnInvestment || 0,
                        unclaimedFees: baseStats.unclaimedFees || 0,
                        apr: baseStats.apr || 0
                    }
                }
            };

            console.log('Formatted LP data:', lpData);
        } else {
            console.warn('Failed to fetch LP positions from Krystal:', lpResponse.status);
        }

               // Step 2: Fetch Avantis positions (unchanged - goes through Railway)
               document.getElementById('verifyStatus').textContent = 'Scanning wallet for perpetual positions...';
        
        console.log('üîµ Step 2: Fetching Avantis positions...');
        const avantisResponse = await fetch(`/api/avantis-positions?address=${walletAddress}`);
        const avantisData = await avantisResponse.json();
        console.log('‚úÖ Avantis response:', avantisData);

        // Step 3: Save positions to MongoDB
        document.getElementById('verifyStatus').textContent = 'Saving positions to database...';
        
        console.log('üîµ Step 3: Preparing to save positions...');
        console.log('LP data:', lpData);
        console.log('Avantis data:', avantisData);
        
        // Create payload
        const positionsPayload = {
            walletAddress,
            lpPositions: lpData.data?.positions || [],
            avantisPositions: avantisData.data?.positions || [],
            metrics: {
                totalPnL: (lpData.data?.summary?.totalPnL || 0) + (avantisData.data?.summary?.totalPnL || 0),
                totalAUM: (lpData.data?.summary?.totalLiquidity || 0) + (avantisData.data?.summary?.totalMargin || 0),
                totalROI: 0
            }
        };
        
        console.log('üì¶ Positions payload:', positionsPayload);
        
        const savePositionsResponse = await fetch('/api/positions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(positionsPayload)
        });
        
        const savePositionsData = await savePositionsResponse.json();
        console.log('‚úÖ Save positions response:', savePositionsData);
        
        if (!savePositionsData.success) {
            console.error('‚ùå Failed to save positions:', savePositionsData);
            throw new Error('Failed to save positions to database');
        }

        // Step 4: Update manager profile with new wallet
        document.getElementById('verifyStatus').textContent = 'Updating profile...';
        
        console.log('üîµ Step 4: Updating manager profile...');
        const updatedWallets = [...existingWallets, walletAddress.toLowerCase()];
        console.log('Updated wallets list:', updatedWallets);

        const updateProfileResponse = await fetch('/api/managers/profile', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: managerData.username,
                wallets: updatedWallets
            })
        });
        
        const updateProfileData = await updateProfileResponse.json();
        console.log('‚úÖ Update profile response:', updateProfileData);
        
        if (!updateProfileData.success) {
            console.error('‚ùå Failed to update profile:', updateProfileData);
            throw new Error('Failed to update manager profile');
        }

        // Step 5: Recalculate aggregate metrics across ALL wallets
        document.getElementById('verifyStatus').textContent = 'Calculating aggregate metrics...';
        console.log('üîµ Step 5: Recalculating metrics for all wallets...');

        let totalPnL = 0;
        let totalAUM = 0;
        let totalPositions = 0;

        // Fetch positions for ALL wallets and sum up
        for (const wallet of updatedWallets) {
            try {
                console.log(`üìä Fetching positions for wallet: ${wallet}`);
                const posResponse = await fetch(`/api/positions?address=${wallet}`);
                const posData = await posResponse.json();
                
                if (posData.success && posData.data) {
                    const lpPositions = posData.data.lpPositions || [];
                    const perpPositions = posData.data.perpPositions || [];
                    
                    console.log(`Found ${lpPositions.length} LP + ${perpPositions.length} perp for ${wallet}`);
                    
                    // Sum PnL
                    lpPositions.forEach(pos => totalPnL += (pos.pnl || 0));
                    perpPositions.forEach(pos => totalPnL += (pos.pnl || 0));
                    
                    // Sum AUM
                    lpPositions.forEach(pos => totalAUM += (pos.liquidity || 0));
                    perpPositions.forEach(pos => totalAUM += (pos.margin || pos.positionSize || 0));
                    
                    totalPositions += lpPositions.length + perpPositions.length;
                } else {
                    console.warn(`No positions found for ${wallet}`);
                }
            } catch (err) {
                console.error('Error fetching positions for', wallet, err);
            }
        }

        const totalROI = totalAUM > 0 ? (totalPnL / totalAUM * 100) : 0;

        console.log('üìä Aggregate metrics calculated:', { 
            totalPnL, 
            totalAUM, 
            totalROI: totalROI.toFixed(2) + '%', 
            totalPositions 
        });

        // Update manager metrics
        const metricsUpdateResponse = await fetch('/api/managers/profile', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: managerData.username,
                metrics: {
                    totalPnL30d: totalPnL,
                    totalAUM: totalAUM,
                    roi30d: totalROI,
                    totalTrades: totalPositions,
                    lastUpdated: new Date().toISOString()
                }
            })
        });

        const metricsUpdateData = await metricsUpdateResponse.json();
        console.log('‚úÖ Metrics update response:', metricsUpdateData);

        console.log('üéâ All steps completed successfully!');
        
        clearInterval(timerInterval);
        closeAddWalletModal();
        
        // Reload dashboard to show updated metrics
        location.reload();

    } catch (error) {
        console.error('‚ùå Error in addAndVerifyWallet:', error);
        console.error('Error stack:', error.stack);
        alert('‚ùå Failed to add wallet: ' + error.message);
        closeAddWalletModal();
    }
}


        // Notes Modal
        function openNotesModal(field) {
            currentNotesField = field;
            const titles = {
                marketOutlook: 'Market Outlook',
                investmentThesis: 'Investment Thesis',
                positionStrategy: 'Position Strategy'
            };
            document.getElementById('notesModalTitle').textContent = titles[field];
            
            const currentContent = managerData[field] || '';
            document.getElementById('notesTextarea').value = currentContent;
            updateWordCount();
            
            document.getElementById('addNotesModal').classList.add('show');
        }

        function closeNotesModal() {
            document.getElementById('addNotesModal').classList.remove('show');
            currentNotesField = null;
        }

        function updateWordCount() {
            const textarea = document.getElementById('notesTextarea');
            const words = textarea.value.trim().split(/\s+/).filter(w => w.length > 0);
            const count = words.length;
            const counter = document.getElementById('notesWordCount');
            
            counter.textContent = `${count} / 100 words`;
            
            if (count > 100) {
                counter.classList.add('error');
                counter.classList.remove('warning');
            } else if (count > 90) {
                counter.classList.add('warning');
                counter.classList.remove('error');
            } else {
                counter.classList.remove('warning', 'error');
            }
        }

        document.getElementById('notesTextarea').addEventListener('input', updateWordCount);

            async function saveNotes() {
        const textarea = document.getElementById('notesTextarea');
        const words = textarea.value.trim().split(/\s+/).filter(w => w.length > 0);
        
        if (words.length > 100) {
            alert('Please keep notes under 100 words');
            return;
        }

        try {
            const updates = { [currentNotesField]: textarea.value };
            
            const response = await fetch('/api/managers/profile', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: managerData.username,
                    ...updates
                })
            });

            if (!response.ok) {
                throw new Error('Failed to save notes');
            }

            // Update local data
            managerData[currentNotesField] = textarea.value;
            
            // Update display immediately
            const display = document.getElementById(currentNotesField + 'Display');
            if (textarea.value.trim()) {
                display.textContent = textarea.value;
                display.classList.remove('empty');
            } else {
                display.textContent = 'No notes added yet';
                display.classList.add('empty');
            }

            closeNotesModal();
            
            console.log('‚úÖ Notes saved successfully');

        } catch (error) {
            console.error('Error saving notes:', error);
            alert('Failed to save notes: ' + error.message);
        }
    }

        // Utility functions
        function formatCurrency(value) {
            const num = parseFloat(value);
            if (Math.abs(num) >= 1000000) return `$${(num / 1000000).toFixed(2)}M`;
            if (Math.abs(num) >= 1000) return `$${(num / 1000).toFixed(2)}k`;
            return `$${num.toFixed(2)}`;
        }

        function formatPercent(value) {
            const sign = value >= 0 ? '+' : '';
            return `${sign}${value.toFixed(2)}%`;
        }

        function formatPrice(value) {
            return `$${parseFloat(value).toFixed(4)}`;
        }

// User type detection
let isOwnDashboard = false;

async function detectUserType() {
    const connectedWallet = localStorage.getItem('connectedWallet');
    
    if (connectedWallet && managerData.walletAddress) {
        isOwnDashboard = connectedWallet.toLowerCase() === managerData.walletAddress.toLowerCase();
    }
    
    if (isOwnDashboard) {
        // Manager viewing own dashboard
        document.getElementById('editPerfFee').style.display = 'block';
        document.getElementById('editAumFee').style.display = 'block';
        document.getElementById('investCTA').style.display = 'none';
        document.getElementById('addWalletBtn').style.display = 'inline-block';
        
        // Hide other manager-only features from investors
        const addNoteBtns = document.querySelectorAll('.notes-label button');
        addNoteBtns.forEach(btn => btn.style.display = 'block');
    } else {
        // Investor viewing manager's dashboard
        document.getElementById('editPerfFee').style.display = 'none';
        document.getElementById('editAumFee').style.display = 'none';
        document.getElementById('investCTA').style.display = 'flex';  // Changed to flex
        document.getElementById('investManagerName').textContent = managerData.username;
        document.getElementById('addWalletBtn').style.display = 'none';
        
        // Hide manager-only features
        const addNoteBtns = document.querySelectorAll('.notes-label button');
        addNoteBtns.forEach(btn => btn.style.display = 'none');
        
        // Hide "Dashboard" nav link for investors
        const dashboardLink = document.getElementById('dashboardLink');
        if (dashboardLink) {
            dashboardLink.style.display = 'none';
        }
    }
}

function displayFeesAndEarnings() {
    if (!managerData) {
        console.error('ERROR: managerData is null in displayFeesAndEarnings!');
        return;
    }
    
    const fees = managerData.fees || { performanceFee: 20, aumFee: 2 };
    const totalEarnings = managerData.totalEarnings || 0;
    const coInvestors = managerData.coInvestorsCount || 0;
    
    document.getElementById('performanceFeeDisplay').textContent = fees.performanceFee + '%';
    document.getElementById('aumFeeDisplay').textContent = fees.aumFee + '%'; // CHANGED
    document.getElementById('totalEarningsDisplay').textContent = formatCurrency(totalEarnings);
    document.getElementById('coInvestorsDisplay').textContent = coInvestors;
}

// Edit Fees Modal
function openEditFeesModal() {
    const fees = managerData.fees || { performanceFee: 20, aumFee: 2 };
    document.getElementById('performanceFeeInput').value = fees.performanceFee;
    document.getElementById('aumFeeInput').value = fees.aumFee; // CHANGED
    document.getElementById('editFeesModal').classList.add('show');
}

function closeEditFeesModal() {
    document.getElementById('editFeesModal').classList.remove('show');
}

async function saveFeesUpdate() {
    const performanceFee = parseFloat(document.getElementById('performanceFeeInput').value);
    const aumFee = parseFloat(document.getElementById('aumFeeInput').value); // CHANGED
    
    if (performanceFee < 0 || performanceFee > 50) {
        alert('Performance fee must be between 0-50%');
        return;
    }
    
    if (aumFee < 0 || aumFee > 5) { // CHANGED
        alert('AUM fee must be between 0-5%');
        return;
    }
    
    try {
        const response = await fetch('/api/managers/profile', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: managerData.username,
                fees: {
                    performanceFee,
                    aumFee  // CHANGED
                },
                lastFeeUpdate: new Date()
            })
        });
        
        if (!response.ok) throw new Error('Failed to update fees');
        
        // Update local data
        managerData.fees = { performanceFee, aumFee }; // CHANGED
        displayFeesAndEarnings();
        closeEditFeesModal();
        
        alert('Fees updated successfully!');
        
    } catch (error) {
        console.error('Error updating fees:', error);
        alert('Failed to update fees');
    }
}

// Invest Modal
function openInvestModal() {
    document.getElementById('investModalUsername').textContent = managerData.username;
    
    // Show manager's fees
    const fees = managerData.fees || { performanceFee: 20, aumFee: 2 };
    document.getElementById('modalPerfFee').textContent = fees.performanceFee + '%';
    document.getElementById('modalAumFee').textContent = fees.aumFee + '%';
    
    document.getElementById('investModal').classList.add('show');
}

function closeInvestModal() {
    document.getElementById('investModal').classList.remove('show');
}

    </script>

   <!-- Edit Fees Modal -->
<div class="modal" id="editFeesModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Fees</h3>
            <button class="close-btn" onclick="closeEditFeesModal()">√ó</button>
        </div>
        
        <div class="modal-input-group">
            <label>Performance Fee (%)</label>
            <input type="number" id="performanceFeeInput" min="0" max="50" step="0.5" value="20">
            <div class="helper-text">Fee charged on profits (0-50%)</div>
        </div>

        <div class="modal-input-group">
            <label>AUM Fee (% annually)</label>
            <input type="number" id="aumFeeInput" min="0" max="5" step="0.1" value="2">
            <div class="helper-text">Annual fee on Assets Under Management (0-5%)</div>
        </div>

        <button class="submit-btn" onclick="saveFeesUpdate()">Update Fees</button>
    </div>
</div>

<!-- Invest Modal -->
<div class="modal" id="investModal">
    <div class="modal-content invest-modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Invest with @<span id="investModalUsername"></span></h3>
            <button class="close-btn" onclick="closeInvestModal()">√ó</button>
        </div>

        <p class="modal-text" style="text-align: center; margin-bottom: 24px; font-size: 15px;">
            Invest alongside top asset managers through Smart Wallets
        </p>

        <div class="feature-grid">
            <div class="feature-item">
                <div class="feature-icon">üîê</div>
                <div class="feature-text">
                    <h4>You Keep Full Ownership</h4>
                    <p>Your funds stay in your wallet. You control your keys and can withdraw anytime.</p>
                </div>
            </div>

            <div class="feature-item">
                <div class="feature-icon">ü§ñ</div>
                <div class="feature-text">
                    <h4>Automated Trade Mirroring</h4>
                    <p>Your smart wallet automatically replicates the manager's trades in real-time.</p>
                </div>
            </div>

            <div class="feature-item">
                <div class="feature-icon">üìä</div>
                <div class="feature-text">
                    <h4>Transparent Performance</h4>
                    <p>All trades are on-chain and verifiable. No hidden positions.</p>
                </div>
            </div>

            <div class="feature-item">
                <div class="feature-icon">üí∞</div>
                <div class="feature-text">
                    <h4>Fair Performance-Based Fees</h4>
                    <p>Performance: <strong id="modalPerfFee">20%</strong> on profits ‚Ä¢ AUM: <strong id="modalAumFee">2%</strong> annually</p>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 24px;">
            <a href="https://discord.com/channels/1426305214176165941/1426305389812646091" target="_blank" class="discord-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                </svg>
                Join Discord for Early Access
            </a>
            <p style="font-size: 12px; color: #8A8A8A; margin-top: 12px;">
                Get notified when smart wallet investing launches
            </p>
        </div>
    </div>
</div>

</body>
</html>
